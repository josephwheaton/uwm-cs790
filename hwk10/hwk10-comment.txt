I see that you have a race condition. It is generally not a good idea to use TMVar like this. You don't get the protection of STM very much. It is better to centralize the logic in one STM per thread. 

The best tool of STM is its 'retry' expression.
